<div class="pattern-selection-container">
  <!-- Alert Messages -->
  <div *ngIf="errorMessage" class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
    <div class="flex items-center">
      <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-sm font-medium text-red-800">{{ errorMessage }}</p>
    </div>
  </div>

  <div *ngIf="successMessage" class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4 mb-6">
    <div class="flex items-center">
      <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-sm font-medium text-green-800">{{ successMessage }}</p>
    </div>
  </div>

  <!-- Fuel Pump Form (Shown when Standard Fuel Pump is selected) -->
  <!-- This will be shown in the right panel, not as a separate full-screen component -->

  <!-- Unified Card: Pattern Type & Instrument Selection -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mb-6">
    <!-- Card Header -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900">Pattern Type & Instrument Selection</h2>
      <p class="text-gray-500 mt-1">Select pattern type and add instruments for approval</p>
    </div>

    <!-- Card Body -->
    <div class="p-6">
      <!-- Pattern Type Selection - Grid View -->
      <div *ngIf="!selectedPatternTypeId" class="mb-6">
        <h3 class="text-lg font-bold text-gray-900 flex items-center mb-4">
          <div class="w-8 h-8 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-2">
            <svg class="w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          Select Pattern Type
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <div *ngFor="let type of patternTypes" 
               (click)="selectedPatternTypeId = type.id; onPatternTypeChange()"
               class="group relative flex items-start p-5 bg-white border-2 border-transparent ring-1 ring-gray-200 rounded-xl cursor-pointer hover:ring-[#F7941D] hover:bg-[#F7941D]/5 transition-all duration-200 shadow-sm hover:shadow-md">
            
            <!-- Icon Container -->
            <div class="w-10 h-10 flex-shrink-0 bg-white border border-gray-100 rounded-full flex items-center justify-center text-gray-400 group-hover:text-[#F7941D] group-hover:border-[#F7941D] transition-colors duration-200 mt-1 shadow-sm">
                <!-- Dynamic Icons -->
                <svg *ngIf="type.name.toLowerCase().includes('weigh')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                <svg *ngIf="type.name.toLowerCase().includes('fuel')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <svg *ngIf="type.name.toLowerCase().includes('water')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                <svg *ngIf="!type.name.toLowerCase().includes('weigh') && !type.name.toLowerCase().includes('fuel') && !type.name.toLowerCase().includes('water')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </div>
            
            <!-- Text Content -->
            <div class="ml-4 flex-grow">
              <div class="flex items-center justify-between mb-1">
                <h4 class="font-bold text-gray-900 group-hover:text-[#F7941D] transition-colors text-base">{{ type.name }}</h4>
                
                <!-- Radio Indicator -->
                <div class="w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-[#F7941D] flex items-center justify-center transition-colors">
                     <div class="w-2.5 h-2.5 rounded-full bg-[#F7941D] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </div>
              </div>
              <p class="text-xs text-gray-500 leading-relaxed">{{ type.description }}</p>
            </div>
          </div>
        </div>

        <div *ngIf="patternTypes.length === 0 && !isLoading" class="text-center py-8 text-gray-500">
          No pattern types available.
        </div>
        
        <div *ngIf="isLoading && !selectedPatternTypeId" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
        </div>
      </div>

       <!-- Selected Pattern Header (Compact) -->
       <div *ngIf="selectedPatternTypeId" class="mb-6 flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-3">
                <svg class="w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase font-semibold">Selected Pattern Type</p>
                <p class="text-lg font-bold text-gray-900">
                    {{ selectedPatternTypeName }}
                </p>
            </div>
        </div>
        <button (click)="changePattern()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 hover:border-[#F7941D] hover:text-[#F7941D] transition-all shadow-sm">
            Change Pattern
        </button>
      </div>

      <!-- Split View: Instrument Categories (Left) & Document Preview (Right) -->
      <div *ngIf="selectedPatternTypeId" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left Side: Instrument Categories (Compact - col-span-4) -->
        <div class="lg:col-span-4 border border-gray-200 rounded-lg overflow-hidden h-fit">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3 class="font-bold text-gray-900 flex items-center text-sm">
              <div class="w-6 h-6 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-2">
                <svg class="w-3 h-3 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
              </div>
              Categories
            </h3>
          </div>
          <div class="p-2 max-h-[600px] overflow-y-auto">
            <div class="space-y-2">
              <div *ngFor="let category of instrumentCategories" class="border border-gray-200 rounded-lg overflow-hidden">
                <!-- Category Header (Static) -->
                <div class="w-full px-3 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                  <span class="font-semibold text-gray-900 text-left text-sm">{{ category.name }}</span>
                </div>

                <!-- Instrument Types (Always Visible) -->
                <div class="p-2 bg-white">
                  <div *ngIf="instrumentTypesByCategory[category.id]" class="space-y-1">
                    <button
                      *ngFor="let type of instrumentTypesByCategory[category.id]"
                      (click)="selectInstrumentType(type)"
                      class="w-full px-3 py-2 border border-gray-200 rounded hover:border-[#F7941D] hover:bg-[#F7941D]/5 transition-all text-left text-xs">
                      <div class="font-medium text-gray-900">{{ type.name }}</div>
                      <div class="text-[10px] text-gray-500 text-nowrap">Code: {{ type.code }}</div>
                    </button>
                  </div>
                  <div *ngIf="!instrumentTypesByCategory[category.id]" class="text-center py-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-[#F7941D] mx-auto"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side: Document Preview / Instrument Form / Fuel Pump Form (Expanded - col-span-8) -->
        <div class="lg:col-span-8 border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3 class="font-bold text-gray-900 flex items-center">
              <div class="w-8 h-8 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-2">
                <svg class="w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              {{ showFuelPumpForm ? 'Fuel Pump Application Form' : (currentInstrument ? 'Instrument Details' : 'Select Instrument') }}
            </h3>
          </div>

          <!-- Fuel Pump Form (Shown when Standard Fuel Pump is selected) -->
          <div *ngIf="showFuelPumpForm" class="p-6 max-h-[600px] overflow-y-auto">
            <app-fuel-pump-form 
              (formSubmitted)="onFuelPumpFormSubmitted($event)"
              (formCancelled)="onFuelPumpFormCancelled()">
            </app-fuel-pump-form>
          </div>

          <!-- Instrument Details Form (For other instruments) -->
          <div *ngIf="currentInstrument" class="p-6 max-h-[600px] overflow-y-auto">
            <div class="mb-6 p-3 bg-[#F7941D]/10 rounded-lg flex justify-between items-center">
                <div>
                     <p class="text-sm font-semibold text-gray-900">{{ currentInstrument.instrument_type_name }}</p>
                    <p class="text-xs text-gray-600">{{ currentInstrument.instrument_type_code }}</p>
                </div>
                <!-- Close/Cancel mini button for quick exit -->
                <button (click)="cancelInstrumentDetails()" class="text-gray-500 hover:text-red-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Brand Name -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Brand Name *</label>
                <input 
                  type="text" 
                  [(ngModel)]="currentInstrument.brand_name"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                  placeholder="Enter brand name">
              </div>

              <!-- Make -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Make *</label>
                <input 
                  type="text" 
                  [(ngModel)]="currentInstrument.make"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                  placeholder="Enter make">
              </div>

              <!-- Accuracy Class (Only for Weighing Instrument) -->
              <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh')">
                <label class="block text-sm font-semibold text-gray-700 mb-2">Accuracy Class *</label>
                <select 
                  [(ngModel)]="currentInstrument.accuracy_class"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm bg-white">
                  <option value="" disabled selected>Select Accuracy Class</option>
                  <option value="High Class (I & II)">High Class (I & II)</option>
                  <option value="Normal Class (III & IV)">Normal Class (III & IV)</option>
                </select>
              </div>

              <!-- Serial Number -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Serial Number *</label>
                <input 
                  type="text" 
                  [(ngModel)]="currentInstrument.serial_number"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                  placeholder="Enter serial number">
              </div>

              <!-- Maximum Capacity -->
              <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">Maximum Capacity *</label>
                <input 
                  type="text" 
                  [(ngModel)]="currentInstrument.maximum_capacity"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                  placeholder="e.g., 100kg">
              </div>

              <!-- Required Documents Table -->
              <div class="col-span-1 md:col-span-2 mt-4">
                <h4 class="text-sm font-bold text-gray-800 mb-3">Required Attachments</h4>
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <tr *ngFor="let doc of instrumentDocuments; let i = index">
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm font-medium text-gray-900">{{ doc.name }}</div>
                          <div *ngIf="currentInstrument[doc.key]" class="text-xs text-green-600 mt-1 flex items-center">
                             <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                             {{ currentInstrument[doc.key].name }}
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span [class]="currentInstrument[doc.key] ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                            {{ currentInstrument[doc.key] ? 'Uploaded' : 'Pending' }}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <div class="flex items-center space-x-2">
                            <!-- Upload Button (Visible if no file) -->
                            <button *ngIf="!currentInstrument[doc.key]" 
                                    (click)="fileInput.click()" 
                                    class="inline-flex items-center px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition-colors duration-200 font-medium text-sm group" 
                                    title="Upload Document">
                              <svg class="w-4 h-4 mr-1.5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                              </svg>
                              Upload
                            </button>

                            <!-- Actions for Uploaded File -->
                            <ng-container *ngIf="currentInstrument[doc.key]">
                              <!-- View Button -->
                              <button (click)="openPreview(currentInstrument[doc.key], doc.name)" 
                                      class="inline-flex items-center justify-center w-9 h-9 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 hover:scale-110 transition-all duration-200" 
                                      title="View Document">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                              </button>
                              
                              <!-- Change/Edit Button -->
                              <button (click)="fileInput.click()" 
                                      class="inline-flex items-center justify-center w-9 h-9 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 hover:scale-110 transition-all duration-200" 
                                      title="Change Document">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                              </button>
                              
                              <!-- Remove Button -->
                              <button (click)="removeDocument(doc.key)" 
                                      class="inline-flex items-center justify-center w-9 h-9 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 hover:scale-110 transition-all duration-200" 
                                      title="Remove Document">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                              </button>
                            </ng-container>

                            <!-- Hidden Input -->
                            <input #fileInput type="file" [accept]="doc.accept" class="hidden" (change)="onFileSelected($event, doc.key)">
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Action Buttons (Span full width) -->
              <div class="md:col-span-2 flex justify-end space-x-3 pt-6 border-t border-gray-200 mt-2">
                <button 
                  (click)="cancelInstrumentDetails()"
                  class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors text-sm font-medium">
                  Cancel
                </button>
                <button 
                  (click)="saveInstrumentDetails()"
                  class="px-6 py-2 bg-[#F7941D] text-white rounded-lg hover:bg-[#e8850c] transition-colors text-sm font-medium">
                  Save Instrument
                </button>
              </div>
            </div>
          </div>

          <!-- Document Preview Area / Empty State -->
          <div *ngIf="!currentInstrument && !showFuelPumpForm" class="p-4 max-h-[600px] overflow-y-auto flex items-center justify-center h-full min-h-[400px]">
            <!-- Empty State / Instruction -->
            <div class="h-full min-h-[500px] flex flex-col items-center justify-center p-8 text-center relative overflow-hidden bg-gray-50/50">
               <!-- Background Decoration -->
               <div class="absolute inset-0 overflow-hidden pointer-events-none select-none">
                  <div class="absolute top-10 left-10 w-32 h-32 bg-[#F7941D]/5 rounded-full blur-3xl"></div>
                  <div class="absolute bottom-10 right-10 w-40 h-40 bg-blue-100/50 rounded-full blur-3xl"></div>
                  <svg class="absolute top-20 right-20 text-gray-200 w-16 h-16 opacity-30 transform rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
               </div>

               <div class="relative z-10 max-w-sm w-full">
                  <!-- Animated Icon Group -->
                  <div class="relative w-24 h-24 mx-auto mb-8">
                      <!-- Pulsing effect -->
                      <div class="absolute inset-0 bg-[#F7941D]/10 rounded-full animate-ping opacity-75"></div>
                      <div class="absolute inset-2 bg-white rounded-full shadow-sm flex items-center justify-center border-2 border-[#F7941D]/20 z-10">
                         <svg class="w-10 h-10 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                         </svg>
                      </div>
                      
                      <!-- Directional Arrow (Desktop only) -->
                      <div class="hidden lg:flex absolute right-[120%] top-1/2 transform -translate-y-1/2 items-center whitespace-nowrap group-hover:translate-x-[-5px] transition-transform duration-500">
                          <svg class="w-12 h-12 text-[#F7941D] transform rotate-180 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                          </svg>
                          <span class="text-sm font-bold text-[#F7941D] uppercase tracking-wide ml-2 bg-white/80 backdrop-blur px-2 py-1 rounded-md shadow-sm border border-orange-100">Start Here</span>
                      </div>
                  </div>

                  <h3 class="text-xl font-bold text-gray-900 mb-3">Select Instrument</h3>
                  
                  <div class="bg-white border border-gray-200 rounded-xl p-5 text-left shadow-sm relative overflow-hidden group hover:border-[#F7941D]/30 transition-colors">
                      <div class="absolute top-0 left-0 w-1 h-full bg-[#F7941D]"></div>
                      <div class="flex items-start">
                          <div class="flex-shrink-0 mt-0.5">
                             <div class="w-5 h-5 rounded-full bg-[#F7941D]/10 flex items-center justify-center">
                               <span class="text-[#F7941D] text-xs font-bold">1</span>
                             </div>
                          </div>
                          <div class="ml-3">
                              <p class="text-sm text-gray-600 leading-relaxed">
                                You are working on <strong>{{ selectedPatternTypeName || 'Pattern Agreement' }}</strong>.
                              </p>
                              <p class="text-sm text-gray-500 mt-2">
                                Choose an instrument type from the list on the left to add its details and documents.
                              </p>
                          </div>
                      </div>
                  </div>
               </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Instruments List -->
  <div *ngIf="selectedInstruments.length > 0" class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mb-6">
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
      <h3 class="text-xl font-bold text-gray-900 flex items-center">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        Selected Instruments ({{ selectedInstruments.length }})
      </h3>
    </div>
    <div class="px-6 py-6">
      <div class="space-y-4">
        <div *ngFor="let instrument of selectedInstruments; let i = index" 
             class="border border-gray-200 rounded-lg p-4 bg-gray-50">
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <h4 class="font-bold text-gray-900">{{ instrument.instrument_type_name }} ({{ instrument.instrument_type_code }})</h4>
              <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
                <div>
                  <span class="text-gray-600 font-medium">Brand:</span>
                  <span class="text-gray-900 ml-2">{{ instrument.brand_name }}</span>
                </div>
                <div>
                  <span class="text-gray-600 font-medium">Make:</span>
                  <span class="text-gray-900 ml-2">{{ instrument.make }}</span>
                </div>
                <div>
                  <span class="text-gray-600 font-medium">Serial Number:</span>
                  <span class="text-gray-900 ml-2">{{ instrument.serial_number }}</span>
                </div>
                <div>
                  <span class="text-gray-600 font-medium">Max Capacity:</span>
                  <span class="text-gray-900 ml-2">{{ instrument.maximum_capacity }}</span>
                </div>
              </div>
              <div class="mt-2 flex space-x-4 text-xs">
                <span *ngIf="instrument.manual_calibration_doc" class="text-green-600 flex items-center">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Manual Calibration Uploaded
                </span>
                <span *ngIf="instrument.specification_doc" class="text-green-600 flex items-center">
                  <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  Specification Uploaded
                </span>
              </div>
            </div>
            <button 
              (click)="removeInstrument(i)"
              class="ml-4 p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Submit Button -->
  <div class="flex justify-end">
    <button 
      (click)="submitApplication()"
      [disabled]="!selectedPatternTypeId || selectedInstruments.length === 0 || isSaving"
      class="px-8 py-3 bg-[#F7941D] text-white rounded-lg hover:bg-[#e8850c] disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold flex items-center">
      <span *ngIf="!isSaving">Submit Application</span>
      <span *ngIf="isSaving" class="flex items-center">
        <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Submitting...
      </span>
    </button>
  </div>
</div>

<!-- Custom Confirmation Modal -->
<div *ngIf="showChangePatternModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-0">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" (click)="cancelChangePattern()"></div>

  <!-- Modal Card -->
  <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:w-full sm:max-w-md overflow-hidden">
    <div class="p-6">
      <div class="flex items-start space-x-4">
        <!-- Icon -->
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        
        <!-- Content -->
        <div class="flex-1">
          <h3 class="text-lg font-bold text-gray-900 mb-2">Change Pattern Type?</h3>
          <p class="text-sm text-gray-500 leading-relaxed">
            Are you sure you want to select a different pattern? 
            <br><br>
            <span class="text-orange-600 font-medium">Warning:</span> Any instruments you have added or details you have entered for the current pattern will be lost.
          </p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
      <button 
        (click)="confirmChangePattern()" 
        class="w-full sm:w-auto px-4 py-2 bg-[#F7941D] hover:bg-[#E58310] text-white text-sm font-medium rounded-lg shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F7941D]">
        Yes, Change Pattern
      </button>
      <button 
        (click)="cancelChangePattern()" 
        class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Document Preview Modal -->
<div *ngIf="showPreviewModal" class="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity" aria-hidden="true" (click)="closePreview()"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal Panel -->
    <div class="relative inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
      
      <!-- Header -->
      <div class="bg-gray-50 px-4 py-3 sm:px-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">
          {{ previewTitle }}
        </h3>
        <button type="button" (click)="closePreview()" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="bg-white h-[70vh]">
        <div *ngIf="previewFileUrl; else noPreview" class="h-full w-full">
            <iframe [src]="previewFileUrl" class="w-full h-full border-0" title="Document Preview"></iframe>
        </div>
        <ng-template #noPreview>
            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <p class="text-lg font-medium">Preview not available for this file type.</p>
                <p class="text-sm">Please download the file to view it.</p>
            </div>
        </ng-template>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200">
        <button type="button" (click)="closePreview()" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
