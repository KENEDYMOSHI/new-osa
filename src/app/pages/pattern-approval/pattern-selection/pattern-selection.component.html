<div class="pattern-selection-container">
  <!-- Alert Messages -->
  <div *ngIf="errorMessage" class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
    <div class="flex items-center">
      <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-sm font-medium text-red-800">{{ errorMessage }}</p>
    </div>
  </div>

  <div *ngIf="successMessage" class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4 mb-6">
    <div class="flex items-center">
      <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-sm font-medium text-green-800">{{ successMessage }}</p>
    </div>
  </div>

  <!-- Fuel Pump Form (Shown when Standard Fuel Pump is selected) -->
  <!-- This will be shown in the right panel, not as a separate full-screen component -->

  <!-- Unified Card: Pattern Type & Instrument Selection -->
  <div class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mb-6">
    <!-- Card Header -->
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
      <h2 class="text-2xl font-bold text-gray-900">Pattern Type & Instrument Selection</h2>
      <p class="text-gray-500 mt-1">Select pattern type and add instruments for approval</p>
    </div>

    <!-- Card Body -->
    <div class="p-6">
      <!-- Pattern Type Selection - Grid View -->
      <div *ngIf="!selectedPatternTypeId" class="mb-6">
        <h3 class="text-lg font-bold text-gray-900 flex items-center mb-4">
          <div class="w-8 h-8 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-2">
            <svg class="w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </div>
          Select Pattern Type
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
          <div *ngFor="let type of patternTypes" 
               (click)="selectedPatternTypeId = type.id; onPatternTypeChange()"
               class="group relative flex items-start p-5 bg-white border-2 border-transparent ring-1 ring-gray-200 rounded-xl cursor-pointer hover:ring-[#F7941D] hover:bg-[#F7941D]/5 transition-all duration-200 shadow-sm hover:shadow-md">
            
            <!-- Icon Container -->
            <div class="w-10 h-10 flex-shrink-0 bg-white border border-gray-100 rounded-full flex items-center justify-center text-gray-400 group-hover:text-[#F7941D] group-hover:border-[#F7941D] transition-colors duration-200 mt-1 shadow-sm">
                <!-- Dynamic Icons -->
                <svg *ngIf="type.name.toLowerCase().includes('weigh')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>
                <svg *ngIf="type.name.toLowerCase().includes('fuel')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                <svg *ngIf="type.name.toLowerCase().includes('water')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path></svg>
                <svg *ngIf="!type.name.toLowerCase().includes('weigh') && !type.name.toLowerCase().includes('fuel') && !type.name.toLowerCase().includes('water')" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </div>
            
            <!-- Text Content -->
            <div class="ml-4 flex-grow">
              <div class="flex items-center justify-between mb-1">
                <h4 class="font-bold text-gray-900 group-hover:text-[#F7941D] transition-colors text-base">{{ type.name }}</h4>
                
                <!-- Radio Indicator -->
                <div class="w-5 h-5 rounded-full border-2 border-gray-300 group-hover:border-[#F7941D] flex items-center justify-center transition-colors">
                     <div class="w-2.5 h-2.5 rounded-full bg-[#F7941D] opacity-0 group-hover:opacity-100 transition-opacity"></div>
                </div>
              </div>
              <p class="text-xs text-gray-500 leading-relaxed">{{ type.description }}</p>
            </div>
          </div>
        </div>

        <div *ngIf="patternTypes.length === 0 && !isLoading" class="text-center py-8 text-gray-500">
          No pattern types available.
        </div>
        
        <div *ngIf="isLoading && !selectedPatternTypeId" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
            <div class="h-32 bg-gray-100 rounded-xl animate-pulse"></div>
        </div>
      </div>

       <!-- Selected Pattern Header (Compact) -->
       <div *ngIf="selectedPatternTypeId" class="mb-6 flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-200">
        <div class="flex items-center">
            <div class="w-8 h-8 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-3">
                <svg class="w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase font-semibold">Selected Pattern Type</p>
                <p class="text-lg font-bold text-gray-900">
                    {{ selectedPatternTypeName }}
                </p>
            </div>
        </div>
        <button (click)="changePattern()" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 hover:border-[#F7941D] hover:text-[#F7941D] transition-all shadow-sm">
            Change Pattern
        </button>
      </div>

      <!-- Split View: Instrument Categories (Left) & Document Preview (Right) -->
      <div *ngIf="selectedPatternTypeId" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
        <!-- Left Side: Instrument Categories (Compact - col-span-4) -->
        <div class="lg:col-span-4 border border-gray-200 rounded-lg overflow-hidden h-fit">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3 class="font-bold text-gray-900 flex items-center text-sm">
              <div class="w-6 h-6 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-2">
                <svg class="w-3 h-3 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
              </div>
              Categories
            </h3>
          </div>
          <div class="p-2 max-h-[600px] overflow-y-auto">
            <div class="space-y-2">
              <div *ngFor="let category of instrumentCategories" 
                   class="border rounded-lg overflow-hidden transition-all duration-300"
                   [ngClass]="{
                     'border-[#F7941D] ring-2 ring-[#F7941D]/20 shadow-md transform scale-[1.02] bg-white relative z-10': selectedInstrumentType?.category_id === category.id,
                     'border-gray-200 hover:border-gray-300': selectedInstrumentType?.category_id !== category.id
                   }">
                <!-- Category Header (Static) -->
                <div class="w-full px-3 py-2 border-b flex items-center justify-between"
                     [ngClass]="selectedInstrumentType?.category_id === category.id ? 'bg-[#F7941D]/10 border-[#F7941D]/20' : 'bg-gray-50 border-gray-200'">
                  <div class="flex items-center">
                    <span class="font-semibold text-left text-sm"
                          [ngClass]="selectedInstrumentType?.category_id === category.id ? 'text-[#F7941D]' : 'text-gray-900'">
                      {{ category.name }}
                    </span>
                    <!-- Active Indicator -->
                    <span *ngIf="selectedInstrumentType?.category_id === category.id" class="ml-2 flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-2 w-2 rounded-full bg-[#F7941D] opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-[#F7941D]"></span>
                    </span>
                  </div>
                  
                  <!-- Optional: Working Label -->
                  <span *ngIf="selectedInstrumentType?.category_id === category.id" class="text-[10px] font-bold uppercase tracking-wider text-[#F7941D] bg-white px-2 py-0.5 rounded-full shadow-sm">
                    Active
                  </span>
                </div>

                <!-- Instrument Types (Always Visible) -->
                <div class="p-2" [ngClass]="selectedInstrumentType?.category_id === category.id ? 'bg-[#F7941D]/5' : 'bg-white'">
                  <div *ngIf="instrumentTypesByCategory[category.id]" class="space-y-1">
                    <button
                      *ngFor="let type of instrumentTypesByCategory[category.id]"
                      (click)="selectInstrumentType(type)"
                      class="w-full px-3 py-2 border rounded transition-all text-left text-xs relative overflow-hidden"
                      [ngClass]="selectedInstrumentType?.id === type.id ? 'border-[#F7941D] bg-white text-[#F7941D] shadow-sm' : 'border-gray-200 hover:border-[#F7941D] hover:bg-[#F7941D]/5 text-gray-900'">
                      
                      <!-- Active Selection Marker -->
                      <div *ngIf="selectedInstrumentType?.id === type.id" class="absolute left-0 top-0 bottom-0 w-1 bg-[#F7941D]"></div>
                      
                      <div class="font-medium truncate pr-4">{{ type.name }}</div>
                      <div class="text-[10px] text-nowrap" [ngClass]="selectedInstrumentType?.id === type.id ? 'text-[#F7941D]/80' : 'text-gray-500'">Code: {{ type.code }}</div>
                      
                      <!-- Selected Checkmark -->
                      <svg *ngIf="selectedInstrumentType?.id === type.id" class="absolute right-2 top-1/2 transform -translate-y-1/2 w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                  </div>
                  <div *ngIf="!instrumentTypesByCategory[category.id]" class="text-center py-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-[#F7941D] mx-auto"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Side: Document Preview / Instrument Form / Fuel Pump Form (Expanded - col-span-8) -->
        <div class="lg:col-span-8 border border-gray-200 rounded-lg overflow-hidden">
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
            <h3 class="font-bold text-gray-900 flex items-center">
              <div class="w-8 h-8 bg-[#F7941D]/10 rounded-full flex items-center justify-center mr-2">
                <svg class="w-4 h-4 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
              </div>
              {{ showFuelPumpForm ? 'Fuel Pump Application Form' : (currentInstrument ? 'Instrument Details' : 'Select Instrument') }}
            </h3>
          </div>

          <!-- Fuel Pump Form (Shown when Standard Fuel Pump is selected) -->
          <div *ngIf="showFuelPumpForm" class="p-6 max-h-[600px] overflow-y-auto">
            <app-fuel-pump-form 
              (formSubmitted)="onFuelPumpFormSubmitted($event)"
              (formCancelled)="onFuelPumpFormCancelled()">
            </app-fuel-pump-form>
          </div>

          <!-- Instrument Details Form (For other instruments) -->
          <div *ngIf="currentInstrument" class="p-6 max-h-[600px] overflow-y-auto">
            <div class="mb-6 p-3 bg-[#F7941D]/10 rounded-lg">
                <div>
                     <p class="text-sm font-semibold text-gray-900">{{ currentInstrument.instrument_type_name }}</p>
                    <p class="text-xs text-gray-600">{{ currentInstrument.instrument_type_code }}</p>
                </div>
            </div>



            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- GENERIC FORM (Non-Meter) -->
              <ng-container *ngIf="!isFlowMeterCategory() && !isElectricalMeterCategory() && !isCapacityMeasureCategory()">
                  <!-- Brand Name -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Brand Name *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.brand_name"
                      [class]="isFieldInvalid(currentInstrument.brand_name) ? 'w-full px-4 py-2 border-2 border-red-500 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent text-sm' : 'w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm'"
                      placeholder="Enter brand name">
                    <p *ngIf="isFieldInvalid(currentInstrument.brand_name)" class="text-red-500 text-xs mt-1">Brand Name is required</p>
                  </div>

                  <!-- Make -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Make *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.make"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter make">
                  </div>
                  
                  <!-- Scale Type Selection (Only for Weighing Instrument) -->
                  <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh')">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Scale Type *</label>
                    <div class="flex items-center space-x-6">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" value="mechanical" name="scale_type" [(ngModel)]="currentInstrument.scale_type" class="w-5 h-5 text-[#F7941D] border-gray-300 focus:ring-[#F7941D]">
                            <span class="ml-2 text-sm text-gray-700">Mechanical</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" value="digital" name="scale_type" [(ngModel)]="currentInstrument.scale_type" class="w-5 h-5 text-[#F7941D] border-gray-300 focus:ring-[#F7941D]">
                            <span class="ml-2 text-sm text-gray-700">Digital</span>
                        </label>
                    </div>
                  </div>
                  
                  <!-- Uses of Weighing Instrument -->
                   <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh')">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Uses of Weighing Instrument *</label>
                    <select class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm bg-white" 
                            [(ngModel)]="currentInstrument.instrument_use" 
                            (ngModelChange)="calculateFee()"
                            [ngModelOptions]="{standalone: true}">
                      <option value="" disabled selected>Select Use</option>
                      <option value="Normal Trade">Normal Trade</option>
                      <option value="Pharmaceutical Laboratory">Pharmaceutical Laboratory</option>
                      <option value="Precision Stones">Precision Stones</option>
                    </select>
                  </div>

                  <!-- Digital Scale Additional Fields -->
                  <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh') && currentInstrument.scale_type === 'digital'" class="col-span-1 md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6 bg-orange-50/50 p-4 rounded-lg border border-orange-100">
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Value of e *</label>
                        <input 
                          type="text" 
                          [(ngModel)]="currentInstrument.value_e"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                          placeholder="Enter value of e">
                      </div>
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Value of d *</label>
                        <input 
                          type="text" 
                          [(ngModel)]="currentInstrument.value_d"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                          placeholder="Enter value of d">
                      </div>
                  </div>

                  <!-- Accuracy Class (Only for Weighing Instrument) -->
                  <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh')">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Accuracy Class *</label>
                    <select 
                      [(ngModel)]="currentInstrument.accuracy_class"
                      (ngModelChange)="calculateFee()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm bg-white">
                      <option value="" disabled selected>Select Accuracy Class</option>
                      <option value="i">I</option>
                      <option value="ii">II</option>
                      <option value="iii">III</option>
                      <option value="iv">IV</option>
                    </select>
                  </div>

                  <!-- Quantity of Instrument (Only for Weighing Instrument) -->
                  <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh')">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity of Instrument *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.quantity"
                      (input)="onQuantityChange()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter quantity">
                  </div>

                  <!-- Serial Numbers (Dynamic - Only for Weighing Instrument) -->
                  <div *ngIf="selectedPatternTypeName.toLowerCase().includes('weigh')" class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-3">Serial Numbers ({{ currentInstrument.serial_numbers?.length || 0 }}) *</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <div *ngFor="let sn of currentInstrument.serial_numbers; let i = index; trackBy: trackByIndex">
                            <input 
                              type="text" 
                              [(ngModel)]="currentInstrument.serial_numbers![i]"
                              class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-[#F7941D] focus:border-[#F7941D]"
                              [placeholder]="'Serial No. ' + (i + 1)">
                        </div>
                    </div>
                  </div>

                  <!-- Serial Number (For non-Weighing Instruments) -->
                  <div *ngIf="!selectedPatternTypeName.toLowerCase().includes('weigh')">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Serial Number *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.serial_number"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter serial number">
                  </div>

                  <!-- Maximum Capacity -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Maximum Capacity *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.maximum_capacity"
                      (ngModelChange)="calculateFee()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="e.g., 100kg">
                  </div>
              </ng-container>

              <!-- FLOW METER FORM (Water/Bulk/Flow) -->
              <ng-container *ngIf="isFlowMeterCategory()">
                  <!-- ... Existing Meter Form Content ... -->
                  <!-- Brand Meter Name -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Brand Meter Name *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.brand_name"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter brand meter name">
                  </div>
                  
                  <!-- Manufacturer -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Manufacturer *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.make"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter manufacturer">
                  </div>

                  <!-- Quantity -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity of meter *</label>
                    <input 
                      type="number" 
                      min="1"
                      [(ngModel)]="currentInstrument.quantity"
                      (input)="onQuantityChange()"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter quantity">
                  </div>

                  <!-- Serial Numbers (Dynamic) -->
                  <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-3">Serial Numbers ({{ currentInstrument.serial_numbers?.length || 0 }}) *</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <div *ngFor="let sn of currentInstrument.serial_numbers; let i = index; trackBy: trackByIndex">
                            <input 
                              type="text" 
                              [(ngModel)]="currentInstrument.serial_numbers![i]"
                              class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-[#F7941D] focus:border-[#F7941D]"
                              [placeholder]="'Serial No. ' + (i + 1)">
                        </div>
                    </div>
                  </div>

                  <!-- Nominal flow rate (Q3) -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nominal flow rate (Q₃) in m³/h *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.nominal_flow_rate"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="e.g. 2.5">
                  </div>

                  <!-- Class of meter -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Class of meter *</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.meter_class"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter class">
                  </div>

                  <!-- Ratio (R) -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Ratio (R) <span class="text-gray-400 font-normal">(Optional)</span></label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.ratio"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="Enter ratio">
                  </div>

                  <!-- MAP -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Maximum Admissible Pressure (MAP)</label>
                    <input 
                      type="text" 
                      [(ngModel)]="currentInstrument.max_admissible_pressure"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                      placeholder="In bar/Mpa">
                  </div>

                  <!-- Max Temperature -->
                  <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Maximum Temperature (T) in °C *</label>
                     <input 
                       type="text" 
                       [(ngModel)]="currentInstrument.max_temperature"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                       placeholder="e.g. 50">
                   </div>

                   <!-- Meter Size (DN) -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Meter Size (DN) *</label>
                     <input 
                       type="text" 
                       [(ngModel)]="currentInstrument.meter_size_dn"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                       placeholder="Enter size (DN)">
                   </div>

                   <!-- Size / Diameter -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Size / Diameter of the meter *</label>
                     <input 
                       type="text" 
                       [(ngModel)]="currentInstrument.diameter"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#F7941D] focus:border-transparent text-sm"
                       placeholder="Enter diameter">
                   </div>

                   <!-- NEW: Position of Measurement H/V -->
                   <div class="col-span-1 md:col-span-2 pt-4 border-t border-gray-100">
                      <label class="block text-sm font-bold text-gray-700 mb-3">Position of measurement H/V *</label>
                      <div class="flex items-center space-x-6">
                          <label class="flex items-center cursor-pointer">
                              <input type="radio" value="horizontal" name="pos_hv" [(ngModel)]="currentInstrument.position_hv_type" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                              <span class="ml-2 text-sm text-gray-700">H (Horizontal)</span>
                          </label>
                          <label class="flex items-center cursor-pointer">
                              <input type="radio" value="vertical" name="pos_hv" [(ngModel)]="currentInstrument.position_hv_type" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                              <span class="ml-2 text-sm text-gray-700">V (Vertical)</span>
                          </label>
                      </div>
                   </div>

                   <!-- NEW: Sealing Mechanism -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                      <label class="block text-sm font-bold text-gray-700 mb-3">Sealing Mechanism / Adjustment knob *</label>
                      <div class="flex items-center space-x-6">
                          <label class="flex items-center cursor-pointer">
                              <input type="radio" value="provided" name="sealing" [(ngModel)]="currentInstrument.sealing_mechanism_type" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                              <span class="ml-2 text-sm text-gray-700">Provided</span>
                          </label>
                          <label class="flex items-center cursor-pointer">
                              <input type="radio" value="not_provided" name="sealing" [(ngModel)]="currentInstrument.sealing_mechanism_type" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                              <span class="ml-2 text-sm text-gray-700">Not Provided</span>
                          </label>
                      </div>
                   </div>

                   <!-- NEW: Direction of Flow -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                       <label class="block text-sm font-bold text-gray-700 mb-3">Direction of flow *</label>
                       <div class="flex items-center space-x-6">
                           <label class="flex items-center cursor-pointer">
                               <input type="radio" value="indicated" name="flow_dir" [(ngModel)]="currentInstrument.flow_direction_type" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                               <span class="ml-2 text-sm text-gray-700">Indicated</span>
                           </label>
                           <label class="flex items-center cursor-pointer">
                               <input type="radio" value="not_indicated" name="flow_dir" [(ngModel)]="currentInstrument.flow_direction_type" class="w-5 h-5 text-blue-600 border-gray-300 focus:ring-blue-500">
                               <span class="ml-2 text-sm text-gray-700">Not Indicated</span>
                           </label>
                       </div>
                   </div>
              </ng-container>

              <!-- ELECTRICAL METER FORM -->
              <ng-container *ngIf="isElectricalMeterCategory()">
                  <!-- Brand Name -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Brand Meter Name *</label>
                    <input type="text" [(ngModel)]="currentInstrument.brand_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter brand name">
                  </div>
                  <!-- Manufacturer -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Meter Manufacturer *</label>
                    <input type="text" [(ngModel)]="currentInstrument.make" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter manufacturer">
                  </div>
                  <!-- Model -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Meter Model *</label>
                    <input type="text" [(ngModel)]="currentInstrument.meter_model" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter model">
                  </div>
                  <!-- Quantity -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity of meter *</label>
                    <input type="number" min="1" [(ngModel)]="currentInstrument.quantity" (input)="onQuantityChange()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter quantity">
                  </div>
                  
                  <!-- Dynamic Serial Numbers (Copied Logic) -->
                  <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                    <label class="block text-sm font-bold text-gray-700 mb-3">Serial Numbers ({{ currentInstrument.serial_numbers?.length || 0 }}) *</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <div *ngFor="let sn of currentInstrument.serial_numbers; let i = index; trackBy: trackByIndex">
                            <input type="text" [(ngModel)]="currentInstrument.serial_numbers![i]" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" [placeholder]="'Serial No. ' + (i + 1)">
                        </div>
                    </div>
                  </div>

                  <!-- Meter Type -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Meter Type *</label>
                    <select [(ngModel)]="currentInstrument.meter_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                        <option value="">Select Type</option>
                        <option value="electromechanical">Electromechanical</option>
                        <option value="static">Static</option>
                    </select>
                  </div>
                  
                  <!-- Accuracy Class -->
                  <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Accuracy class *</label>
                    <select [(ngModel)]="currentInstrument.accuracy_class" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                        <option value="">Select Class</option>
                        <option value="i">I</option>
                        <option value="ii">II</option>
                        <option value="iii">III</option>
                        <option value="iv">IV</option>
                    </select>
                  </div>

                  <!-- Ratings -->
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nominal Voltage (Unom) V *</label><input type="text" [(ngModel)]="currentInstrument.nominal_voltage" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. 230"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Nominal Frequency (fnom) Hz *</label><input type="text" [(ngModel)]="currentInstrument.nominal_frequency" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. 50"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Maximum Current (Imax) A *</label><input type="text" [(ngModel)]="currentInstrument.maximum_current" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. 100"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Transitional Current (Itr) A</label><input type="text" [(ngModel)]="currentInstrument.transitional_current" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Optional"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Minimum Current (Imin) A *</label><input type="text" [(ngModel)]="currentInstrument.minimum_current" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. 5"></div>
                  <div><label class="block text-sm font-semibold text-gray-700 mb-2">Starting Current (Ist) A</label><input type="text" [(ngModel)]="currentInstrument.starting_current" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Optional"></div>

                  <!-- Connection Type -->
                  <div class="col-span-1 md:col-span-2 pt-2">
                      <label class="block text-sm font-bold text-gray-700 mb-2">Connection Type *</label>
                      <div class="flex flex-wrap gap-4">
                        <label class="flex items-center"><input type="radio" value="direct" name="conn_type" [(ngModel)]="currentInstrument.connection_type" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Direct-connected</span></label>
                        <label class="flex items-center"><input type="radio" value="ct" name="conn_type" [(ngModel)]="currentInstrument.connection_type" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Current transformer</span></label>
                        <label class="flex items-center"><input type="radio" value="ct_vt" name="conn_type" [(ngModel)]="currentInstrument.connection_type" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Current and Voltage transformers</span></label>
                      </div>
                  </div>

                  <!-- Connection Mode -->
                  <div class="col-span-1 md:col-span-2">
                       <label class="block text-sm font-semibold text-gray-700 mb-2">Connection mode (phases, wires, elements) *</label>
                       <input type="text" [(ngModel)]="currentInstrument.connection_mode" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. 3-phase 4-wire">
                  </div>
                  <div class="col-span-1 md:col-span-2">
                       <label class="block text-sm font-semibold text-gray-700 mb-2">Alternative connection mode(s)</label>
                       <input type="text" [(ngModel)]="currentInstrument.alternative_connection_mode" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Optional">
                  </div>

                  <!-- Energy Flow Direction -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                       <label class="block text-sm font-bold text-gray-700 mb-2">Direction of energy flow / registers *</label>
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                           <label class="flex items-center"><input type="radio" value="single_bi" name="energy_dir" [(ngModel)]="currentInstrument.energy_flow_direction" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Single-register, bi-directional</span></label>
                           <label class="flex items-center"><input type="radio" value="single_pos" name="energy_dir" [(ngModel)]="currentInstrument.energy_flow_direction" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Single-register, positive direction only</span></label>
                           <label class="flex items-center"><input type="radio" value="two_bi" name="energy_dir" [(ngModel)]="currentInstrument.energy_flow_direction" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Two-register, bi-directional</span></label>
                           <label class="flex items-center"><input type="radio" value="single_uni" name="energy_dir" [(ngModel)]="currentInstrument.energy_flow_direction" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">Single-register, uni-directional</span></label>
                       </div>
                   </div>

                   <div>
                       <label class="block text-sm font-semibold text-gray-700 mb-2">
                           Meter constant * 
                           <span class="text-gray-500 font-normal italic text-xs ml-1">(include units of measurement)</span>
                       </label>
                       <input type="text" [(ngModel)]="currentInstrument.meter_constant" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Include units">
                   </div>
                   <div>
                       <label class="block text-sm font-semibold text-gray-700 mb-2">
                           Specified clock frequencies
                           <span class="text-gray-500 font-normal italic text-xs ml-1">(include units of measurement)</span>
                       </label>
                       <input type="text" [(ngModel)]="currentInstrument.clock_frequency" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Include units">
                   </div>
                   
                   <div>
                       <label class="block text-sm font-semibold text-gray-700 mb-2">Environment (Indoor/Outdoor) *</label>
                       <select [(ngModel)]="currentInstrument.environment" class="w-full px-4 py-2 border text-sm rounded-lg bg-white">
                           <option value="">Select Environment</option>
                           <option value="indoor">Indoor</option>
                           <option value="outdoor">Outdoor</option>
                           <option value="indoor_outdoor">Indoor / Outdoor</option>
                       </select>
                   </div>
                   <div><label class="block text-sm font-semibold text-gray-700 mb-2">IP Rating *</label><input type="text" [(ngModel)]="currentInstrument.ip_rating" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. IP54"></div>
                   <div><label class="block text-sm font-semibold text-gray-700 mb-2">Terminal arrangement</label><input type="text" [(ngModel)]="currentInstrument.terminal_arrangement" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="e.g. BS, DIN"></div>
                   <div><label class="block text-sm font-semibold text-gray-700 mb-2">Insulation protection class</label><input type="text" [(ngModel)]="currentInstrument.insulation_protection_class" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Enter class"></div>
                
                   <!-- Temperatures -->
                   <!-- Lower Temp -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                       <label class="block text-sm font-bold text-gray-700 mb-2">Lower specified temperature *</label>
                       <div class="flex flex-wrap gap-4">
                           <label class="flex items-center"><input type="radio" value="-55" name="temp_low" [(ngModel)]="currentInstrument.temperature_lower" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">-55°C</span></label>
                           <label class="flex items-center"><input type="radio" value="-40" name="temp_low" [(ngModel)]="currentInstrument.temperature_lower" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">-40°C</span></label>
                           <label class="flex items-center"><input type="radio" value="-25" name="temp_low" [(ngModel)]="currentInstrument.temperature_lower" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">-25°C</span></label>
                           <label class="flex items-center"><input type="radio" value="-10" name="temp_low" [(ngModel)]="currentInstrument.temperature_lower" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">-10°C</span></label>
                           <label class="flex items-center"><input type="radio" value="+5" name="temp_low" [(ngModel)]="currentInstrument.temperature_lower" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">+5°C</span></label>
                       </div>
                   </div>
                   <!-- Upper Temp -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                       <label class="block text-sm font-bold text-gray-700 mb-2">Upper specified temperature *</label>
                       <div class="flex flex-wrap gap-4">
                           <label class="flex items-center"><input type="radio" value="+30" name="temp_high" [(ngModel)]="currentInstrument.temperature_upper" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">+30°C</span></label>
                           <label class="flex items-center"><input type="radio" value="+40" name="temp_high" [(ngModel)]="currentInstrument.temperature_upper" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">+40°C</span></label>
                           <label class="flex items-center"><input type="radio" value="+55" name="temp_high" [(ngModel)]="currentInstrument.temperature_upper" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">+55°C</span></label>
                           <label class="flex items-center"><input type="radio" value="+70" name="temp_high" [(ngModel)]="currentInstrument.temperature_upper" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">+70°C</span></label>
                       </div>
                   </div>
                   
                   <!-- Humidity -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                       <label class="block text-sm font-bold text-gray-700 mb-2">Humidity class *</label>
                       <div class="flex flex-wrap gap-6">
                           <label class="flex items-center"><input type="radio" value="H1" name="hum_class" [(ngModel)]="currentInstrument.humidity_class" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">H1</span></label>
                           <label class="flex items-center"><input type="radio" value="H2" name="hum_class" [(ngModel)]="currentInstrument.humidity_class" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">H2</span></label>
                           <label class="flex items-center"><input type="radio" value="H3" name="hum_class" [(ngModel)]="currentInstrument.humidity_class" class="w-5 h-5 text-blue-600 focus:ring-blue-500"><span class="ml-2 text-sm">H3</span></label>
                       </div>
                   </div>

                   <!-- Versions & Remarks -->
                   <div><label class="block text-sm font-semibold text-gray-700 mb-2">Hardware version(s)</label><input type="text" [(ngModel)]="currentInstrument.hardware_version" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Optional"></div>
                   <div><label class="block text-sm font-semibold text-gray-700 mb-2">Software version(s)</label><input type="text" [(ngModel)]="currentInstrument.software_version" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Optional"></div>
                   <div class="col-span-1 md:col-span-2">
                       <label class="block text-sm font-semibold text-gray-700 mb-2">Result/Remarks</label>
                       <textarea [(ngModel)]="currentInstrument.remarks" rows="2" class="w-full px-4 py-2 border text-sm rounded-lg" placeholder="Enter remarks"></textarea>
                   </div>
                   
                   <!-- Test Values Section -->
                   <div class="col-span-1 md:col-span-2 mt-4 pt-4 border-t-2 border-dashed border-gray-200">
                       <h3 class="font-bold text-md text-gray-800 mb-1">Test values</h3>
                       <p class="text-sm text-gray-600 mb-4 italic">When ranges of values are specified by the manufacturer, the values used for testing shall be specified below.</p>
                       <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                           <div><label class="block text-sm font-semibold text-gray-700 mb-2">Test voltage (V)</label><input type="text" [(ngModel)]="currentInstrument.test_voltage" class="w-full px-4 py-2 border text-sm rounded-lg"></div>
                           <div><label class="block text-sm font-semibold text-gray-700 mb-2">Test frequency (Hz)</label><input type="text" [(ngModel)]="currentInstrument.test_frequency" class="w-full px-4 py-2 border text-sm rounded-lg"></div>
                           <div class="col-span-1 md:col-span-2"><label class="block text-sm font-semibold text-gray-700 mb-2">Test connection mode</label><input type="text" [(ngModel)]="currentInstrument.test_connection_mode" class="w-full px-4 py-2 border text-sm rounded-lg"></div>
                           <div class="col-span-1 md:col-span-2"><label class="block text-sm font-semibold text-gray-700 mb-2">Remarks</label><textarea [(ngModel)]="currentInstrument.test_remarks" rows="2" class="w-full px-4 py-2 border text-sm rounded-lg"></textarea></div>
                       </div>
                   </div>

              </ng-container>

              <!-- CAPACITY MEASURE FORM -->
              <ng-container *ngIf="isCapacityMeasureCategory()">
                   <!-- Brand Name -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Brand Name *</label>
                     <input type="text" [(ngModel)]="currentInstrument.brand_name" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter brand name">
                   </div>
                   <!-- Manufacturer -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Manufacturers Name (Make) *</label>
                     <input type="text" [(ngModel)]="currentInstrument.make" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter manufacturer">
                   </div>
                   <!-- Model Type -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Model Type</label>
                     <input type="text" [(ngModel)]="currentInstrument.meter_model" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter model type">
                   </div>
                   <!-- Quantity -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity *</label>
                     <input type="number" min="1" [(ngModel)]="currentInstrument.quantity" (input)="onQuantityChange()" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter quantity">
                   </div>

                   <!-- Dynamic Serial Numbers -->
                   <div class="col-span-1 md:col-span-2 bg-gray-50 p-4 rounded-lg border border-gray-200">
                     <label class="block text-sm font-bold text-gray-700 mb-3">Serial Numbers ({{ currentInstrument.serial_numbers?.length || 0 }}) *</label>
                     <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                         <div *ngFor="let sn of currentInstrument.serial_numbers; let i = index; trackBy: trackByIndex">
                             <input type="text" [(ngModel)]="currentInstrument.serial_numbers![i]" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" [placeholder]="'Serial No. ' + (i + 1)">
                         </div>
                     </div>
                   </div>

                   <!-- Material of Construction -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Material of Construction *</label>
                     <input type="text" [(ngModel)]="currentInstrument.material_construction" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g. Mild Steel">
                   </div>
                   <!-- Year of Manufacture -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Year of Manufacture *</label>
                     <input type="text" [(ngModel)]="currentInstrument.year_manufacture" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g. 2024">
                   </div>

                   <!-- Measurement Unit -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Units of Measurement *</label>
                     <select [(ngModel)]="currentInstrument.measurement_unit" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm bg-white">
                         <option value="">Select Unit</option>
                         <option value="Litre">Litre</option>
                         <option value="Cubic Metre">Cubic Metre</option>
                     </select>
                   </div>
                   <!-- Nominal Capacity -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Nominal Capacity (L / m³) *</label>
                     <input type="text" [(ngModel)]="currentInstrument.nominal_capacity" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="Enter capacity">
                   </div>
                   
                   <!-- Max Permissible Error -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Maximum Permissible Error *</label>
                     <input type="text" [(ngModel)]="currentInstrument.max_permissible_error" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g. +/- 0.5%">
                   </div>
                   <!-- Temperature Range -->
                   <div>
                     <label class="block text-sm font-semibold text-gray-700 mb-2">Temperature Range *</label>
                     <input type="text" [(ngModel)]="currentInstrument.temperature_range" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g. -10°C to 50°C">
                   </div>
                   
                   <!-- Intended Liquid -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                       <label class="block text-sm font-bold text-gray-700 mb-2">Intended Liquid *</label>
                       <!-- Simple Text input for now to store as string easily, or implement checkboxes helper -->
                       <!-- User requested checkboxes: Petrol, Kerosene, Diesel, Water -->
                       <!-- I will simulate checkboxes using a temporary UI that updates the model string -->
                       <div class="flex flex-wrap gap-4 bg-gray-50 p-3 rounded border border-gray-200">
                           <label class="flex items-center space-x-2">
                               <input type="radio" value="Petrol" name="intended_liquid" [(ngModel)]="currentInstrument.intended_liquid" class="text-[#F7941D] focus:ring-[#F7941D] rounded w-4 h-4">
                               <span class="text-sm text-gray-700">Petrol</span>
                           </label>
                           <label class="flex items-center space-x-2">
                               <input type="radio" value="Kerosene" name="intended_liquid" [(ngModel)]="currentInstrument.intended_liquid" class="text-[#F7941D] focus:ring-[#F7941D] rounded w-4 h-4">
                               <span class="text-sm text-gray-700">Kerosene</span>
                           </label>
                           <label class="flex items-center space-x-2">
                               <input type="radio" value="Diesel" name="intended_liquid" [(ngModel)]="currentInstrument.intended_liquid" class="text-[#F7941D] focus:ring-[#F7941D] rounded w-4 h-4">
                               <span class="text-sm text-gray-700">Diesel</span>
                           </label>
                           <label class="flex items-center space-x-2">
                               <input type="radio" value="Water" name="intended_liquid" [(ngModel)]="currentInstrument.intended_liquid" class="text-[#F7941D] focus:ring-[#F7941D] rounded w-4 h-4">
                               <span class="text-sm text-gray-700">Water</span>
                           </label>
                       </div>
                   </div>

                   <!-- Yes/No Questions -->
                   <!-- Seal Arrangement -->
                   <div class="col-span-1 md:col-span-2 pt-2">
                      <div class="flex items-center justify-between bg-white p-3 border rounded-lg">
                          <label class="text-sm font-semibold text-gray-700">Seal mechanism provided</label>
                          <div class="flex items-center space-x-4">
                              <label class="flex items-center"><input type="radio" value="Yes" name="seal_arr" [(ngModel)]="currentInstrument.has_seal_arrangement" class="mr-2 text-[#F7941D] focus:ring-[#F7941D]">Yes</label>
                              <label class="flex items-center"><input type="radio" value="No" name="seal_arr" [(ngModel)]="currentInstrument.has_seal_arrangement" class="mr-2 text-[#F7941D] focus:ring-[#F7941D]">No</label>
                          </div>
                      </div>
                   </div>

                   <!-- Adjustment Mechanism -->
                   <div class="col-span-1 md:col-span-2">
                      <div class="flex items-center justify-between bg-white p-3 border rounded-lg">
                          <label class="text-sm font-semibold text-gray-700">Adjustment mechanism provided</label>
                          <div class="flex items-center space-x-4">
                              <label class="flex items-center"><input type="radio" value="Yes" name="adj_mech" [(ngModel)]="currentInstrument.has_adjustment_mechanism" class="mr-2 text-[#F7941D] focus:ring-[#F7941D]">Yes</label>
                              <label class="flex items-center"><input type="radio" value="No" name="adj_mech" [(ngModel)]="currentInstrument.has_adjustment_mechanism" class="mr-2 text-[#F7941D] focus:ring-[#F7941D]">No</label>
                          </div>
                      </div>
                   </div>

                   <!-- Gauge Glass -->
                   <div class="col-span-1 md:col-span-2">
                      <div class="flex items-center justify-between bg-white p-3 border rounded-lg">
                          <label class="text-sm font-semibold text-gray-700">Gauge glass / sight tube / sight glass provided</label>
                          <div class="flex items-center space-x-4">
                              <label class="flex items-center"><input type="radio" value="Yes" name="gauge_glass" [(ngModel)]="currentInstrument.has_gauge_glass" class="mr-2 text-[#F7941D] focus:ring-[#F7941D]">Yes</label>
                              <label class="flex items-center"><input type="radio" value="No" name="gauge_glass" [(ngModel)]="currentInstrument.has_gauge_glass" class="mr-2 text-[#F7941D] focus:ring-[#F7941D]">No</label>
                          </div>
                      </div>
                   </div>
              </ng-container>


              <!-- Required Documents Table -->
              <div class="col-span-1 md:col-span-2 mt-4">
                <h4 class="text-sm font-bold text-gray-800 mb-3">Required Attachments</h4>
                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                  <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                      <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Document Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                      </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                      <ng-container *ngFor="let doc of instrumentDocuments; let i = index">
                      <tr *ngIf="shouldShowDocument(doc.key)">
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm font-medium text-gray-900">{{ doc.name }}</div>
                          <div *ngIf="currentInstrument[doc.key]" class="text-xs text-green-600 mt-1 flex items-center">
                             <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                             {{ currentInstrument[doc.key].name }}
                          </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <span [class]="currentInstrument[doc.key] ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'" class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full">
                            {{ currentInstrument[doc.key] ? 'Uploaded' : 'Pending' }}
                          </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                          <div class="flex items-center space-x-2">
                            <!-- Upload Button (Visible if no file) -->
                            <button *ngIf="!currentInstrument[doc.key]" 
                                    (click)="fileInput.click()" 
                                    class="inline-flex items-center px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg hover:bg-indigo-100 transition-colors duration-200 font-medium text-sm group" 
                                    title="Upload Document">
                              <svg class="w-4 h-4 mr-1.5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                              </svg>
                              Upload
                            </button>

                            <!-- Actions for Uploaded File -->
                            <ng-container *ngIf="currentInstrument[doc.key]">
                              <!-- View Button -->
                              <button (click)="openPreview(currentInstrument[doc.key], doc.name)" 
                                      class="inline-flex items-center justify-center w-9 h-9 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 hover:scale-110 transition-all duration-200" 
                                      title="View Document">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                              </button>
                              
                              <!-- Change/Edit Button -->
                              <button (click)="fileInput.click()" 
                                      class="inline-flex items-center justify-center w-9 h-9 bg-amber-50 text-amber-600 rounded-lg hover:bg-amber-100 hover:scale-110 transition-all duration-200" 
                                      title="Change Document">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                                </svg>
                              </button>
                              
                              <!-- Remove Button -->
                              <button (click)="removeDocument(doc.key)" 
                                      class="inline-flex items-center justify-center w-9 h-9 bg-red-50 text-red-600 rounded-lg hover:bg-red-100 hover:scale-110 transition-all duration-200" 
                                      title="Remove Document">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                              </button>
                            </ng-container>

                            <!-- Hidden Input -->
                            <input #fileInput type="file" [accept]="doc.accept" class="hidden" (change)="onFileSelected($event, doc.key)">
                          </div>
                        </td>
                      </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Application Fee Calculation Card (Inside Form) -->
              <div *ngIf="applicationFee > 0 && (!selectedPatternTypeName.toLowerCase().includes('meter') || currentInstrument.brand_name)" class="col-span-1 md:col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6">
                <div class="flex items-center mb-4">
                  <svg class="w-5 h-5 text-blue-800 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 3.666V14h-6v-3.334H5V18h14v-3.334h-2V7z M9 7V4h6v3"></path>
                  </svg>
                  <h3 class="text-lg font-bold text-blue-900">Application Fee Calculation</h3>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                   <!-- Application Details -->
                   <div class="space-y-3">
                      <div class="flex items-center justify-between border-b border-blue-200 pb-2">
                         <span class="text-sm font-medium text-gray-600">Pattern Type:</span>
                         <span class="text-sm font-bold text-gray-900">{{ selectedPatternTypeName }}</span>
                      </div>
                      <div class="flex items-center justify-between border-b border-blue-200 pb-2">
                         <span class="text-sm font-medium text-gray-600">Instrument Category:</span>
                         <span class="text-sm font-bold text-gray-900">{{ selectedInstrumentCategories }}</span>
                      </div>
                   </div>

                  <!-- Final Fee Only -->
                  <div class="flex items-center justify-between bg-white px-4 py-4 rounded-lg border border-blue-100 shadow-sm">
                      <span class="text-sm font-bold text-gray-700 uppercase tracking-wider">Pattern Fee</span>
                      <span class="text-2xl font-bold text-blue-800">TZS {{ applicationFee | number }}</span>
                  </div>
               </div>

                <div class="flex items-center text-xs text-blue-700 bg-blue-100/50 p-2 rounded">
                   <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                   Fee is per application based on category. Quantity does not affect calculation.
                </div>
              </div>

              <!-- Action Buttons (Span full width) -->
              <div class="md:col-span-2 flex justify-end space-x-3 pt-6 border-t border-gray-200 mt-2">
                <button 
                  (click)="cancelInstrumentDetails()"
                  class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors text-sm font-medium">
                  Cancel
                </button>
                <button 
                  (click)="saveInstrumentDetails()"
                  class="px-6 py-2 bg-[#F7941D] text-white rounded-lg hover:bg-[#e8850c] transition-colors text-sm font-medium">
                  Save Instrument
                </button>
              </div>
            </div>
          </div>

          <!-- Document Preview Area / Empty State -->
          <div *ngIf="!currentInstrument && !showFuelPumpForm" class="p-4 max-h-[600px] overflow-y-auto flex items-center justify-center h-full min-h-[400px]">
            <!-- Empty State / Instruction -->
            <div class="h-full min-h-[500px] flex flex-col items-center justify-center p-8 text-center relative overflow-hidden bg-gray-50/50">
               <!-- Background Decoration -->
               <div class="absolute inset-0 overflow-hidden pointer-events-none select-none">
                  <div class="absolute top-10 left-10 w-32 h-32 bg-[#F7941D]/5 rounded-full blur-3xl"></div>
                  <div class="absolute bottom-10 right-10 w-40 h-40 bg-blue-100/50 rounded-full blur-3xl"></div>
                  <svg class="absolute top-20 right-20 text-gray-200 w-16 h-16 opacity-30 transform rotate-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
               </div>

               <div class="relative z-10 max-w-sm w-full">
                  <!-- Animated Icon Group -->
                  <div class="relative w-24 h-24 mx-auto mb-8">
                      <!-- Pulsing effect -->
                      <div class="absolute inset-0 bg-[#F7941D]/10 rounded-full animate-ping opacity-75"></div>
                      <div class="absolute inset-2 bg-white rounded-full shadow-sm flex items-center justify-center border-2 border-[#F7941D]/20 z-10">
                         <svg class="w-10 h-10 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                         </svg>
                      </div>
                      
                      <!-- Directional Arrow (Desktop only) -->
                      <div class="hidden lg:flex absolute right-[120%] top-1/2 transform -translate-y-1/2 items-center whitespace-nowrap group-hover:translate-x-[-5px] transition-transform duration-500">
                          <svg class="w-12 h-12 text-[#F7941D] transform rotate-180 drop-shadow-sm" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
                          </svg>
                          <span class="text-sm font-bold text-[#F7941D] uppercase tracking-wide ml-2 bg-white/80 backdrop-blur px-2 py-1 rounded-md shadow-sm border border-orange-100">Start Here</span>
                      </div>
                  </div>

                  <h3 class="text-xl font-bold text-gray-900 mb-3">Select Instrument</h3>
                  
                  <div class="bg-white border border-gray-200 rounded-xl p-5 text-left shadow-sm relative overflow-hidden group hover:border-[#F7941D]/30 transition-colors">
                      <div class="absolute top-0 left-0 w-1 h-full bg-[#F7941D]"></div>
                      <div class="flex items-start">
                          <div class="flex-shrink-0 mt-0.5">
                             <div class="w-5 h-5 rounded-full bg-[#F7941D]/10 flex items-center justify-center">
                               <span class="text-[#F7941D] text-xs font-bold">1</span>
                             </div>
                          </div>
                          <div class="ml-3">
                              <p class="text-sm text-gray-600 leading-relaxed">
                                You are working on <strong>{{ selectedPatternTypeName || 'Pattern Agreement' }}</strong>.
                              </p>
                              <p class="text-sm text-gray-500 mt-2">
                                Choose an instrument type from the list on the left to add its details and documents.
                              </p>
                          </div>
                      </div>
                  </div>
               </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Selected Instruments List -->
  <div *ngIf="selectedInstruments.length > 0" class="bg-white rounded-lg shadow-md border border-gray-200 overflow-hidden mb-6">
    <div class="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-b border-gray-200">
      <h3 class="text-xl font-bold text-gray-900 flex items-center">
        <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center mr-3">
          <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        Selected Instruments ({{ selectedInstruments.length }})
      </h3>
    </div>
    <div class="px-6 py-6">
      <div class="space-y-4">
        <div *ngFor="let instrument of selectedInstruments; let i = index" 
             class="border border-gray-200 rounded-lg p-4 bg-gray-50">
            <div class="flex justify-between items-start">
            <div class="flex-1">
              <div class="flex items-center justify-between mb-4">
                  <h4 class="font-bold text-lg text-gray-900">{{ instrument.instrument_type_name }} <span class="text-gray-500 font-normal">({{ instrument.instrument_type_code }})</span></h4>
                  <span class="px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                    Qty: {{ instrument.quantity || 1 }}
                  </span>
                  <span class="px-3 py-1 ml-2 rounded-full text-xs font-medium bg-green-100 text-green-800" *ngIf="instrument.calculated_fee">
                    Fee: {{ instrument.calculated_fee | number }} TZS
                  </span>
              </div>
              
              <!-- General Info -->
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 text-sm mb-4">
                <div *ngIf="instrument.brand_name">
                  <span class="block text-gray-500 text-xs uppercase tracking-wider font-semibold">Brand</span>
                  <span class="text-gray-900 font-medium">{{ instrument.brand_name }}</span>
                </div>
                <div *ngIf="instrument.make">
                  <span class="block text-gray-500 text-xs uppercase tracking-wider font-semibold">Make/Manufacturer</span>
                  <span class="text-gray-900 font-medium">{{ instrument.make }}</span>
                </div>
                <div *ngIf="instrument.meter_model">
                    <span class="block text-gray-500 text-xs uppercase tracking-wider font-semibold">Model</span>
                    <span class="text-gray-900 font-medium">{{ instrument.meter_model }}</span>
                </div>
                <div *ngIf="instrument.serial_number">
                  <span class="block text-gray-500 text-xs uppercase tracking-wider font-semibold">Serial Number</span>
                  <span class="text-gray-900 font-medium break-all">{{ instrument.serial_number }}</span>
                </div>
                <div *ngIf="instrument.serial_numbers && instrument.serial_numbers.length > 0">
                    <span class="block text-gray-500 text-xs uppercase tracking-wider font-semibold">Serial Numbers</span>
                    <div class="text-gray-900 font-medium max-h-20 overflow-y-auto text-xs bg-gray-100 p-2 rounded">
                        {{ instrument.serial_numbers.join(', ') }}
                    </div>
                </div>
              </div>

              <!-- Weighing Instrument Specifics -->
               <div *ngIf="instrument.maximum_capacity || instrument.accuracy_class" class="border-t border-gray-200 pt-3 mb-4">
                  <h5 class="text-xs font-bold text-gray-400 uppercase mb-3">Technical Specifications</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-4 text-sm">
                      <div *ngIf="instrument.scale_type">
                          <span class="text-gray-500 mr-2">Scale Type:</span>
                          <span class="font-medium capitalize">{{ instrument.scale_type }}</span>
                      </div>
                      <div *ngIf="instrument.maximum_capacity">
                          <span class="text-gray-500 mr-2">Max Capacity:</span>
                          <span class="font-medium">{{ instrument.maximum_capacity }}</span>
                      </div>
                      <div *ngIf="instrument.accuracy_class">
                          <span class="text-gray-500 mr-2">Accuracy Class:</span>
                          <span class="font-medium uppercase">{{ instrument.accuracy_class }}</span>
                      </div>
                       <div *ngIf="instrument.value_e">
                          <span class="text-gray-500 mr-2">Value (e):</span>
                          <span class="font-medium">{{ instrument.value_e }}</span>
                      </div>
                       <div *ngIf="instrument.value_d">
                          <span class="text-gray-500 mr-2">Value (d):</span>
                          <span class="font-medium">{{ instrument.value_d }}</span>
                      </div>
                      <div *ngIf="instrument.instrument_use">
                          <span class="text-gray-500 mr-2">Usage:</span>
                          <span class="font-medium">{{ instrument.instrument_use }}</span>
                      </div>
                  </div>
               </div>

               <!-- Meter Specifics -->
               <div *ngIf="instrument.nominal_flow_rate || instrument.nominal_voltage" class="border-t border-gray-200 pt-3 mb-4">
                  <h5 class="text-xs font-bold text-gray-400 uppercase mb-3">Technical Specifications</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-2 text-sm">
                      <!-- Flow Meter -->
                      <div *ngIf="instrument.nominal_flow_rate">
                          <span class="text-gray-500 block text-xs">Nominal Flow Rate (Q3)</span>
                          <span class="font-medium">{{ instrument.nominal_flow_rate }}</span>
                      </div>
                      <div *ngIf="instrument.meter_class">
                          <span class="text-gray-500 block text-xs">Meter Class</span>
                          <span class="font-medium">{{ instrument.meter_class }}</span>
                      </div>
                      <div *ngIf="instrument.meter_size_dn">
                          <span class="text-gray-500 block text-xs">Meter Size (DN)</span>
                          <span class="font-medium">{{ instrument.meter_size_dn }}</span>
                      </div>
                      <div *ngIf="instrument.diameter">
                          <span class="text-gray-500 block text-xs">Diameter</span>
                          <span class="font-medium">{{ instrument.diameter }}</span>
                      </div>
                      <div *ngIf="instrument.ratio">
                          <span class="text-gray-500 block text-xs">Ratio</span>
                          <span class="font-medium">{{ instrument.ratio }}</span>
                      </div>
                      <div *ngIf="instrument.max_admissible_pressure">
                          <span class="text-gray-500 block text-xs">Max Pressure</span>
                          <span class="font-medium">{{ instrument.max_admissible_pressure }}</span>
                      </div>
                      <div *ngIf="instrument.max_temperature">
                          <span class="text-gray-500 block text-xs">Max Temp</span>
                          <span class="font-medium">{{ instrument.max_temperature }}°C</span>
                      </div>
                      <div *ngIf="instrument.position_hv_type">
                          <span class="text-gray-500 block text-xs">Position</span>
                          <span class="font-medium uppercase">{{ instrument.position_hv_type }}</span>
                      </div>
                       <div *ngIf="instrument.flow_direction_type">
                          <span class="text-gray-500 block text-xs">Flow Direction</span>
                          <span class="font-medium capitalize">{{ instrument.flow_direction_type?.replace('_', ' ') }}</span>
                      </div>

                      <!-- Electrical Meter -->
                      <div *ngIf="instrument.meter_type">
                          <span class="text-gray-500 block text-xs">Meter Type</span>
                          <span class="font-medium capitalize">{{ instrument.meter_type }}</span>
                      </div>
                      <div *ngIf="instrument.nominal_voltage">
                          <span class="text-gray-500 block text-xs">Voltage</span>
                          <span class="font-medium">{{ instrument.nominal_voltage }} V</span>
                      </div>
                      <div *ngIf="instrument.nominal_frequency">
                          <span class="text-gray-500 block text-xs">Frequency</span>
                          <span class="font-medium">{{ instrument.nominal_frequency }} Hz</span>
                      </div>
                      <div *ngIf="instrument.maximum_current">
                          <span class="text-gray-500 block text-xs">Max Current</span>
                          <span class="font-medium">{{ instrument.maximum_current }} A</span>
                      </div>
                      <div *ngIf="instrument.minimum_current">
                          <span class="text-gray-500 block text-xs">Min Current</span>
                          <span class="font-medium">{{ instrument.minimum_current }} A</span>
                      </div>
                      <div *ngIf="instrument.connection_type">
                          <span class="text-gray-500 block text-xs">Connection</span>
                          <span class="font-medium uppercase">{{ instrument.connection_type }}</span>
                      </div>
                       <div *ngIf="instrument.environment">
                          <span class="text-gray-500 block text-xs">Environment</span>
                          <span class="font-medium capitalize">{{ instrument.environment }}</span>
                      </div>
                       <div *ngIf="instrument.ip_rating">
                          <span class="text-gray-500 block text-xs">IP Rating</span>
                          <span class="font-medium">{{ instrument.ip_rating }}</span>
                      </div>
                  </div>
               </div>

               <!-- Capacity Measure Specifics -->
               <div *ngIf="instrument.material_construction || instrument.nominal_capacity" class="border-t border-gray-200 pt-3 mb-4">
                  <h5 class="text-xs font-bold text-gray-400 uppercase mb-3">Technical Specifications</h5>
                  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-2 text-sm">
                      <div *ngIf="instrument.material_construction">
                          <span class="text-gray-500 block text-xs">Material</span>
                          <span class="font-medium">{{ instrument.material_construction }}</span>
                      </div>
                       <div *ngIf="instrument.nominal_capacity">
                          <span class="text-gray-500 block text-xs">Capacity</span>
                          <span class="font-medium">{{ instrument.nominal_capacity }} {{ instrument.measurement_unit }}</span>
                      </div>
                       <div *ngIf="instrument.year_manufacture">
                          <span class="text-gray-500 block text-xs">Year</span>
                          <span class="font-medium">{{ instrument.year_manufacture }}</span>
                      </div>
                      <div *ngIf="instrument.max_permissible_error">
                          <span class="text-gray-500 block text-xs">Max Error</span>
                          <span class="font-medium">{{ instrument.max_permissible_error }}</span>
                      </div>
                      <div *ngIf="instrument.temperature_range">
                          <span class="text-gray-500 block text-xs">Temp Range</span>
                          <span class="font-medium">{{ instrument.temperature_range }}</span>
                      </div>
                      <div *ngIf="instrument.intended_liquid">
                          <span class="text-gray-500 block text-xs">Liquid</span>
                          <span class="font-medium">{{ instrument.intended_liquid }}</span>
                      </div>
                  </div>
               </div>

              <!-- Documents -->
              <div class="border-t border-gray-200 pt-3 mb-2">
                 <h5 class="text-xs font-bold text-gray-400 uppercase mb-2">Attached Documents</h5>
                 <div class="flex flex-wrap gap-3">
                    <span *ngIf="instrument.manual_calibration_doc" 
                          (click)="openPreview(instrument.manual_calibration_doc, 'Manual Calibration Document')"
                          class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200 transition-colors"
                          title="Click to view">
                        <svg class="mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Manual Calibration
                    </span>
                     <span *ngIf="instrument.specification_doc" 
                           (click)="openPreview(instrument.specification_doc, 'Specification Document')"
                           class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200 transition-colors"
                           title="Click to view">
                        <svg class="mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Specifications
                    </span>
                     <span *ngIf="instrument.type_approval_doc" 
                           (click)="openPreview(instrument.type_approval_doc, 'Type Approval Certificate')"
                           class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200 transition-colors"
                           title="Click to view">
                        <svg class="mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Type Approval
                    </span>
                     <span *ngIf="instrument.other_doc" 
                           (click)="openPreview(instrument.other_doc, 'Other Document')"
                           class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200 transition-colors"
                           title="Click to view">
                        <svg class="mr-1.5 h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        Other Doc
                    </span>
                 </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col space-y-2 ml-4">
                <button 
                (click)="editInstrument(i)"
                class="p-2 text-blue-600 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors border border-blue-200"
                title="Edit Instrument">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
              </button>
              <button 
                (click)="removeInstrument(i)"
                class="p-2 text-red-600 bg-red-50 hover:bg-red-100 rounded-lg transition-colors border border-red-200"
                title="Remove Instrument">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Submit Button -->
  <!-- Submit Button & Fee Summary -->


  <!-- Submit Button -->
  <!-- Submit Button -->
  <div class="flex justify-end mt-4">
    <ng-container *ngIf="!isSubmitted">
      <button 
        (click)="submitApplication()"
        [disabled]="!selectedPatternTypeId || selectedInstruments.length === 0 || isSaving"
        class="px-8 py-3 bg-[#F7941D] text-white rounded-lg hover:bg-[#e8850c] disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-semibold flex items-center shadow-lg shadow-orange-200">
        <span *ngIf="!isSaving">Submit Application</span>
        <span *ngIf="isSaving" class="flex items-center">
          <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Submitting...
        </span>
      </button>
    </ng-container>

    <ng-container *ngIf="isSubmitted">
      <div class="flex items-center space-x-4">
        <div class="flex items-center text-green-600 font-bold px-4 py-2 bg-green-50 rounded-lg border border-green-200">
             <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
             Submitted Successfully
        </div>
        <button 
          (click)="startNewApplication()"
          class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold shadow-lg shadow-blue-200">
          Start New Application
        </button>
      </div>
    </ng-container>
  </div>
</div>

<!-- Custom Confirmation Modal -->
<div *ngIf="showChangePatternModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-0">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" (click)="cancelChangePattern()"></div>

  <!-- Modal Card -->
  <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:w-full sm:max-w-md overflow-hidden">
    <div class="p-6">
      <div class="flex items-start space-x-4">
        <!-- Icon -->
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
        </div>
        
        <!-- Content -->
        <div class="flex-1">
          <h3 class="text-lg font-bold text-gray-900 mb-2">Change Pattern Type?</h3>
          <p class="text-sm text-gray-500 leading-relaxed">
            Are you sure you want to select a different pattern? 
            <br><br>
            <span class="text-orange-600 font-medium">Warning:</span> Any instruments you have added or details you have entered for the current pattern will be lost.
          </p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
      <button 
        (click)="confirmChangePattern()" 
        class="w-full sm:w-auto px-4 py-2 bg-[#F7941D] hover:bg-[#E58310] text-white text-sm font-medium rounded-lg shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F7941D]">
        Yes, Change Pattern
      </button>
      <button 
        (click)="cancelChangePattern()" 
        class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Save Instrument Confirmation Modal -->
<div *ngIf="showSaveConfirmModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 sm:p-0">
  <!-- Backdrop -->
  <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" (click)="cancelSaveInstrument()"></div>

  <!-- Modal Card -->
  <div class="relative bg-white rounded-2xl shadow-xl transform transition-all sm:w-full sm:max-w-md overflow-hidden">
    <div class="p-6">
      <div class="flex items-start space-x-4">
        <!-- Icon -->
        <div class="flex-shrink-0 w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
          <svg class="w-6 h-6 text-[#F7941D]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        
        <!-- Content -->
        <div class="flex-1">
          <h3 class="text-lg font-bold text-gray-900 mb-2">Save Instrument Details?</h3>
          <p class="text-sm text-gray-500 leading-relaxed">
            Are you sure you want to save this instrument? 
            <br><br>
            <span class="text-orange-600 font-medium">Warning:</span> Once saved, you will <strong>NOT</strong> be able to edit this instrument's details.
            <br><br>
            Please review all information carefully before confirming.
          </p>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="bg-gray-50 px-6 py-4 flex flex-row-reverse gap-3">
      <button 
        (click)="confirmSaveInstrument()" 
        class="w-full sm:w-auto px-4 py-2 bg-[#F7941D] hover:bg-[#E58310] text-white text-sm font-medium rounded-lg shadow-sm transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#F7941D]">
        Yes, Save Instrument
      </button>
      <button 
        (click)="cancelSaveInstrument()" 
        class="w-full sm:w-auto px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
        Cancel
      </button>
    </div>
  </div>
</div>

<!-- Document Preview Modal -->
<div *ngIf="showPreviewModal" class="fixed inset-0 z-[60] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-900/80 backdrop-blur-sm transition-opacity" aria-hidden="true" (click)="closePreview()"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal Panel -->
    <div class="relative inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
      
      <!-- Header -->
      <div class="bg-gray-50 px-4 py-3 sm:px-6 border-b border-gray-200 flex justify-between items-center">
        <h3 class="text-lg leading-6 font-bold text-gray-900" id="modal-title">
          {{ previewTitle }}
        </h3>
        <button type="button" (click)="closePreview()" class="bg-white rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
          <span class="sr-only">Close</span>
          <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <!-- Content -->
      <div class="bg-white h-[70vh]">
        <div *ngIf="previewFileUrl; else noPreview" class="h-full w-full flex items-center justify-center bg-gray-100">
            <iframe *ngIf="previewFile?.type === 'application/pdf'" [src]="previewFileUrl" class="w-full h-full border-0" title="Document Preview"></iframe>
            <img *ngIf="previewFile?.type?.startsWith('image/')" [src]="previewFileUrl" class="max-w-full max-h-full object-contain" alt="Document Preview">
        </div>
        <ng-template #noPreview>
            <div class="flex flex-col items-center justify-center h-full text-gray-500">
                <svg class="w-16 h-16 mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                <p class="text-lg font-medium">Preview not available for this file type.</p>
                <p class="text-sm">Please download the file to view it.</p>
            </div>
        </ng-template>
      </div>

      <!-- Footer -->
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse border-t border-gray-200">
        <button type="button" (click)="closePreview()" class="w-full inline-flex justify-center rounded-lg border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
